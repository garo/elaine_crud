<%# Edit form wrapped in turbo-frame for seamless inline editing %>
<%# Calculate how many columns we have in the grid %>
<% header_layout = calculate_layout_header(columns.map(&:to_sym)) %>
<% total_columns = header_layout.length %>

<%# Edit form spans all columns %>
<%= form_with model: record, url: "/#{controller_path}/#{record.id}", method: :patch, class: "contents" do |form| %>
  <%= hidden_field_tag :from_inline_edit, true %>

  <%# Form content spanning all columns (including actions column) %>
  <div class="bg-blue-50 border-2 border-blue-400 p-6 border-b <%= row_bg_class %>" style="grid-column: 1 / -1;" data-record-id="<%= record_id %>">
    <%# Calculate layout for this record %>
    <% record_layout = calculate_layout(record, columns.map(&:to_sym)) %>

    <%# Render layout rows for editing %>
    <% record_layout.each_with_index do |layout_row, row_index| %>
      <%# Single CSS Grid container with synchronized column widths %>
      <div class="grid gap-x-4 gap-y-4 <%= 'mb-4' unless row_index == record_layout.length - 1 %>" style="grid-template-columns: 1fr 2fr 1fr;">
        <% layout_row.each_with_index do |column_config, col_index| %>
          <% field_name = column_config[:field_name] %>
          <% colspan = column_config[:colspan] || 1 %>
          <% rowspan = column_config[:rowspan] || 1 %>

          <%# Column 1: Field Name/Title %>
          <div class="text-sm font-medium text-gray-700 py-3 <%= 'border-b border-blue-200' unless col_index == layout_row.length - 1 %> <%= 'col-span-' + colspan.to_s if colspan > 1 %>">
            <%= field_title(field_name) %>
            <% if record.errors[field_name].any? %>
              <div class="text-red-500 font-normal text-xs mt-1">
                <%= record.errors[field_name].first %>
              </div>
            <% end %>
          </div>

          <%# Column 2: Form Input %>
          <div class="py-2 <%= 'border-b border-blue-200' unless col_index == layout_row.length - 1 %> <%= 'col-span-' + colspan.to_s if colspan > 1 %>">
            <%= render_form_field(form, record, field_name) %>
          </div>

          <%# Column 3: Field Description %>
          <div class="text-xs text-gray-500 py-3 <%= 'border-b border-blue-200' unless col_index == layout_row.length - 1 %> <%= 'col-span-' + colspan.to_s if colspan > 1 %>">
            <% if field_description(field_name).present? %>
              <%= field_description(field_name) %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# Action buttons at the bottom %>
    <div class="flex justify-end space-x-3 pt-6 border-t-2 border-blue-300 mt-6">
      <%= form.submit "Save Changes",
          class: "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow-md border border-green-700" %>
      <%= link_to "Cancel",
          url_for(action: :index),
          class: "bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded shadow-md border-2 border-gray-400" %>
    </div>
  </div>
<% end %>